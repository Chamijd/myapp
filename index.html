<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CHAMA MD WEB </title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins&display=swap');
  body {
    font-family: 'Poppins', sans-serif;
    background: #f9f9f9;
    margin: 0; padding: 0;
  }
  .container {
    max-width: 700px;
    margin: 30px auto;
    padding: 0 20px;
  }
  h2 {
    text-align: center;
    margin-bottom: 20px;
  }

  /* Login/Register form */
  #authForm, #commentSection {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
    margin-bottom: 30px;
  }
  #authForm input, #commentSection input, #commentSection textarea {
    width: 100%;
    padding: 10px;
    margin-top: 8px;
    margin-bottom: 15px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 15px;
  }
  #authForm button, #commentSection button {
    cursor: pointer;
    background: #4caf50;
    border: none;
    color: white;
    padding: 12px 18px;
    font-size: 16px;
    border-radius: 6px;
    transition: background 0.3s ease;
  }
  #authForm button:hover, #commentSection button:hover {
    background: #388e3c;
  }

  /* Message box */
  #message {
    opacity: 0;
    transition: opacity 0.5s ease;
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: #4caf50;
    color: white;
    padding: 12px 18px;
    border-radius: 6px;
    z-index: 9999;
    pointer-events: none;
    font-weight: 600;
    user-select: none;
  }
  #message.show {
    opacity: 1;
    pointer-events: auto;
  }
  #message.error {
    background-color: #f44336;
  }

  /* Comments list */
  #commentsList, .reply-list {
    list-style: none;
    padding-left: 0;
  }
  .comment-item {
    background: #fafafa;
    margin-bottom: 15px;
    padding: 12px 15px;
    border-radius: 8px;
    border: 1px solid #ddd;
    position: relative;
  }
  .comment-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 14px;
    color: #333;
  }
  .comment-user {
    font-weight: 700;
    color: #2e7d32;
  }
  .comment-date {
    font-style: italic;
    color: #666;
  }
  .comment-text {
    margin: 0 0 10px 0;
    font-size: 15px;
    white-space: pre-wrap;
  }
  .reply-button {
    background: #1976d2;
    border: none;
    color: white;
    font-size: 13px;
    padding: 5px 10px;
    border-radius: 5px;
    cursor: pointer;
    user-select: none;
    transition: background 0.3s ease;
  }
  .reply-button:hover {
    background: #115293;
  }

  /* Reply list indentation */
  .reply-list {
    padding-left: 25px;
    margin-top: 10px;
  }

  /* Reply form styling */
  .reply-form {
    margin-top: 10px;
  }
  .reply-form textarea {
    width: 100%;
    height: 70px;
    border-radius: 6px;
    border: 1px solid #ccc;
    resize: vertical;
    padding: 8px;
    font-size: 14px;
  }
  .reply-form button {
    margin-top: 8px;
    background: #388e3c;
  }
  .reply-form button:hover {
    background: #2e7d32;
  }

  /* Logout and welcome */
  #welcomeMsg {
    text-align: center;
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 20px;
    color: #2e7d32;
  }
  #logoutBtn {
    display: block;
    margin: 0 auto 30px auto;
    padding: 10px 20px;
    background: #d32f2f;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 15px;
    transition: background 0.3s ease;
  }
  #logoutBtn:hover {
    background: #9a2222;
  }
</style>
</head>
<body>
<div class="container">
  <h2>CHMA MD Login/Register & Comment System</h2>

  <!-- LOGIN/REGISTER FORM -->
  <div id="authForm">
    <input type="text" id="username" placeholder="Enter username" required />
    <input type="password" id="password" placeholder="Enter password" required />
    <button id="registerBtn">Register</button>
    <button id="loginBtn">Login</button>
  </div>

  <!-- WELCOME + LOGOUT -->
  <div id="welcomeSection" style="display:none;">
    <div id="welcomeMsg"></div>
    <button id="logoutBtn">Logout</button>
  </div>

  <!-- COMMENT SECTION -->
  <div id="commentSection" style="display:none;">
    <textarea id="commentInput" rows="3" placeholder="Write a comment..."></textarea>
    <button id="postCommentBtn">Post Comment</button>
    <ul id="commentsList"></ul>
  </div>
</div>

<div id="message"></div>

<script>
  // ELEMENTS
  const authForm = document.getElementById('authForm');
  const usernameInput = document.getElementById('username');
  const passwordInput = document.getElementById('password');
  const registerBtn = document.getElementById('registerBtn');
  const loginBtn = document.getElementById('loginBtn');

  const welcomeSection = document.getElementById('welcomeSection');
  const welcomeMsg = document.getElementById('welcomeMsg');
  const logoutBtn = document.getElementById('logoutBtn');

  const commentSection = document.getElementById('commentSection');
  const commentInput = document.getElementById('commentInput');
  const postCommentBtn = document.getElementById('postCommentBtn');
  const commentsList = document.getElementById('commentsList');

  const messageDiv = document.getElementById('message');

  // USER SESSION
  let currentUser = null;

  // COMMENTS DATA STRUCTURE
  // comments = [ { id, user, text, createdAt, replies: [same structure] } ]
  let comments = [];

  // REPLY STATE
  let replyingTo = null; // id of comment being replied to

  // UTILS

  // Show animated message (success=true/false for colors)
  function showMessage(text, success = true) {
    messageDiv.textContent = text;
    messageDiv.className = success ? 'show' : 'show error';
    
    clearTimeout(messageDiv._timeout);
    messageDiv._timeout = setTimeout(() => {
      messageDiv.className = '';
    }, 3000);
  }

  // Save users to localStorage
  function saveUsers(users) {
    localStorage.setItem('users', JSON.stringify(users));
  }

  // Load users from localStorage
  function loadUsers() {
    const users = localStorage.getItem('users');
    return users ? JSON.parse(users) : [];
  }

  // Save comments
  function saveComments() {
    localStorage.setItem('comments', JSON.stringify(comments));
  }

  // Load comments
  function loadCommentsFromStorage() {
    const saved = localStorage.getItem('comments');
    if (saved) comments = JSON.parse(saved);
    else comments = [];
  }

  // Find comment recursively by id
  function findCommentById(commentArray, id) {
    for (const c of commentArray) {
      if (c.id === id) return c;
      if (c.replies && c.replies.length > 0) {
        const found = findCommentById(c.replies, id);
        if (found) return found;
      }
    }
    return null;
  }

  // Clear all reply forms visible
  function removeAllReplyForms() {
    document.querySelectorAll('.reply-form').forEach(form => form.remove());
  }

  // Toggle reply form under comment li element
  function toggleReplyForm(commentId, liElement) {
    // If already replying to same comment => cancel
    if (replyingTo === commentId) {
      replyingTo = null;
      removeAllReplyForms();
      return;
    }
    replyingTo = commentId;
    removeAllReplyForms();

    // Create reply form
    const form = document.createElement('form');
    form.className = 'reply-form';

    const textarea = document.createElement('textarea');
    textarea.placeholder = 'Write your reply...';
    textarea.required = true;
    form.appendChild(textarea);

    const submitBtn = document.createElement('button');
    submitBtn.textContent = 'Post Reply';
    form.appendChild(submitBtn);

    form.onsubmit = e => {
      e.preventDefault();
      const replyText = textarea.value.trim();
      if (!replyText) return showMessage('Reply cannot be empty', false);

      // Find comment object and add reply
      const parentComment = findCommentById(comments, commentId);
      if (!parentComment) return showMessage('Parent comment not found', false);
      if (!parentComment.replies) parentComment.replies = [];

      parentComment.replies.push({
        id: Date.now() + Math.random(),
        user: currentUser,
        text: replyText,
        createdAt: Date.now(),
        replies: []
      });
      saveComments();
      showMessage('Reply posted!');

      // Reset reply state and reload
      replyingTo = null;
      removeAllReplyForms();
      renderComments();
    };

    liElement.appendChild(form);
    textarea.focus();
  }

  // Render comments recursively
  function renderComments() {
    commentsList.innerHTML = '';
    // Sort comments by date ascending
    comments.sort((a, b) => a.createdAt - b.createdAt);

    function renderList(commentsArr, parentUl) {
      commentsArr.forEach(c => {
        const li = document.createElement('li');
        li.className = 'comment-item';

        const headerDiv = document.createElement('div');
        headerDiv.className = 'comment-header';

        const userSpan = document.createElement('span');
        userSpan.className = 'comment-user';
        userSpan.textContent = c.user;

        const dateSpan = document.createElement('span');
        dateSpan.className = 'comment-date';
        dateSpan.textContent = new Date(c.createdAt).toLocaleString();

        headerDiv.appendChild(userSpan);
        headerDiv.appendChild(dateSpan);

        const textP = document.createElement('p');
        textP.className = 'comment-text';
        textP.textContent = c.text;

        li.appendChild(headerDiv);
        li.appendChild(textP);

        // Reply button
        const replyBtn = document.createElement('button');
        replyBtn.className = 'reply-button';
        replyBtn.textContent = replyingTo === c.id ? 'Cancel Reply' : 'Reply';
        replyBtn.onclick = () => toggleReplyForm(c.id, li);
        li.appendChild(replyBtn);

        // Render replies recursively
        if (c.replies && c.replies.length > 0) {
          const replyUl = document.createElement('ul');
          replyUl.className = 'reply-list';
          renderList(c.replies, replyUl);
          li.appendChild(replyUl);
        }

        parentUl.appendChild(li);
      });
    }

    renderList(comments, commentsList);
  }

  // Register user
  registerBtn.onclick = () => {
    const user = usernameInput.value.trim();
    const pass = passwordInput.value.trim();
    if (!user || !pass) return showMessage('Username and password required', false);

    const users = loadUsers();
    if (users.some(u => u.username === user)) {
      return showMessage('Username already taken', false);
    }
    users.push({ username: user, password: pass });
    saveUsers(users);
    showMessage('Registered successfully! Now login.');
    usernameInput.value = '';
    passwordInput.value = '';
  };

  // Login user
  loginBtn.onclick = () => {
    const user = usernameInput.value.trim();
    const pass = passwordInput.value.trim();
    if (!user || !pass) return showMessage('Username and password required', false);

    const users = loadUsers();
    const foundUser = users.find(u => u.username === user && u.password === pass);
    if (!foundUser) return showMessage('Invalid username or password', false);

    currentUser = user;
    showMessage('Logged in successfully!');
    usernameInput.value = '';
    passwordInput.value = '';

    // Show welcome & comments, hide auth
    welcomeMsg.textContent = `Welcome, ${currentUser}!`;
    authForm.style.display = 'none';
    welcomeSection.style.display = 'block';
    commentSection.style.display = 'block';

    loadCommentsFromStorage();
    renderComments();
  };

  // Logout
  logoutBtn.onclick = () => {
    currentUser = null;
    authForm.style.display = 'block';
    welcomeSection.style.display = 'none';
    commentSection.style.display = 'none';
    commentsList.innerHTML = '';
    showMessage('Logged out!');
  };

  // Post new top-level comment
  postCommentBtn.onclick = () => {
    if (!currentUser) return showMessage('Login required to comment', false);

    const text = commentInput.value.trim();
    if (!text) return showMessage('Comment cannot be empty', false);

    comments.push({
      id: Date.now() + Math.random(),
      user: currentUser,
      text: text,
      createdAt: Date.now(),
      replies: []
    });
    saveComments();
    commentInput.value = '';
    showMessage('Comment posted!');
    renderComments();
  };

  // On load: check if user logged in? (Optional)
  // We can store session in localStorage to keep logged in (optional)
</script>
</body>
</html>
